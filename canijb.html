<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rage’s JB Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { @apply bg-gray-900 text-white p-6 flex flex-col items-center; }
        h1 { @apply text-3xl font-bold mb-4; }
        .card { @apply bg-gray-800 p-6 rounded-lg max-w-lg w-full mb-5 shadow-lg; }
        .title { @apply text-xl font-semibold text-center mb-3; }
        .info { @apply text-sm text-gray-400 mb-2; }
        select { @apply w-full bg-gray-700 p-2 rounded mt-3; }
        .list { @apply hidden bg-gray-700 p-4 rounded mt-3; }
        ul { @apply space-y-1; }
    </style>
</head>
<body>

    <h1>Rage’s JB Checker</h1>
    <div id="content"></div>
    <p class="text-center text-gray-400 mt-4">
        Source: <a href="https://github.com/littlebyteorg/appledb" target="_blank" class="text-blue-400 underline">littlebyteorg/appledb</a>
    </p>

    <script>
        const apiBase = "https://api.github.com/repos/littlebyteorg/appledb/contents/jailbreakFiles";
        const rawBase = "https://raw.githubusercontent.com/littlebyteorg/appledb/main/jailbreakFiles/";
        const devCache = new Map();

        async function getDevInfo(id) {
            if (devCache.has(id)) return devCache.get(id);
            const url = `https://api.ipsw.me/v4/device/${id}?type=ipsw`;
            let info = { name: id, vers: new Map() };

            try {
                let res = await fetch(url);
                if (!res.ok) throw new Error();
                let d = await res.json();
                info.name = d.name || id;
                d.firmwares?.forEach(f => info.vers.set(f.buildid, f.version));
                devCache.set(id, info);
            } catch (e) {}

            return info;
        }

        async function fetchJBs() {
            try {
                let res = await fetch(apiBase);
                let data = await res.json();
                data.filter(f => f.name.endsWith(".json")).forEach(f => fetchJBFile(f.name));
            } catch (e) {}
        }

        async function fetchJBFile(file) {
            try {
                let res = await fetch(rawBase + file);
                let data = await res.json();
                processJB(data, file);
            } catch (e) {}
        }

        async function processJB(data, file) {
            const card = document.createElement("div");
            card.className = "card";

            const title = document.createElement("h2");
            title.className = "title";
            title.textContent = data.info?.name?.trim() || file.replace(".json", "");

            const latest = mk("Latest Version", data.info?.latestVer);
            const type = mk("Type", data.info?.type);
            const notes = mk("Notes", data.info?.notes);

            const sel = document.createElement("select");
            sel.innerHTML = `<option value="">Select a device</option>`;

            const listWrap = document.createElement("div");
            listWrap.className = "list";
            const list = document.createElement("ul");

            let devMap = {};

            for (const e of data.compatibility) {
                for (const v of e.devices) {
                    if (!devMap[v]) devMap[v] = new Set();
                    e.firmwares.forEach(fw => devMap[v].add(fw));
                }
            }

            const uniqueDevs = Object.keys(devMap);
            const devs = await Promise.all(uniqueDevs.map(getDevInfo));

            uniqueDevs.forEach((v, i) => {
                let opt = document.createElement("option");
                opt.value = v;
                opt.textContent = devs[i].name;
                sel.appendChild(opt);
            });

            sel.addEventListener("change", function () {
                let v = this.value;
                list.innerHTML = "";
                if (v) {
                    let knownVers = [], unknownVers = [];
                    devMap[v].forEach(fw => {
                        let devInfo = devCache.get(v);
                        let ios = devInfo?.vers?.get(fw);
                        if (ios) knownVers.push(ios);
                        else unknownVers.push(fw);
                    });

                    knownVers.sort().forEach(ios => appendListItem(list, ios));
                    unknownVers.sort().forEach(fw => appendListItem(list, fw));

                    listWrap.classList.remove("hidden");
                } else {
                    listWrap.classList.add("hidden");
                }
            });

            listWrap.appendChild(list);
            card.append(title, latest, type, notes, sel, listWrap);
            document.getElementById("content").appendChild(card);
        }

        function mk(k, v) {
            const p = document.createElement("p");
            p.className = "info";
            p.innerHTML = `<strong>${k}:</strong> ${v || "N/A"}`;
            return p;
        }

        function appendListItem(list, text) {
            let li = document.createElement("li");
            li.textContent = text;
            list.appendChild(li);
        }

        fetchJBs();
    </script>

</body>
</html>
